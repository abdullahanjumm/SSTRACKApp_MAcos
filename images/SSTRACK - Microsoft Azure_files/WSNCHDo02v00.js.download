define("MsPortalImpl/Services/PermissionsHelpers",["require","exports","FxHubs/ArmHelpers/ArmApisStartup","FxHubs/Helpers/PermissionsHelpers","Fx/ResourceManagement","MsPortalImpl/Services/Services.Permissions"],(function(e,s,r,t,n,o){"use strict";Object.defineProperty(s,"__esModule",{value:!0}),s.hasPermission=s.getPermissionsFromArm=s.getPermissions=s.hasPermissionsImpl=void 0;var i=MsPortalFx.Base,c=MsPortalFx.Base.Diagnostics.Telemetry;const a=[{actions:["*"],notActions:[]}],u="\\*";MsPortalFx.isDevelopmentMode,new i.Diagnostics.Log("MsPortalImpl/Services/Services.Permissions");function l(e){return e.replace(/([.*+?^=!:${}()|[\]/\\])/g,"\\$1").replace("\\/\\*\\/","\\/?\\*\\/").replace(u,".*").replace("\0",u).replace("\\t","\t").replace("\\n","\n").replace("\\r","\r").replace("\\\\","\\").replace("\\'","'")}function m(e){return function(e){const s=l(e=e.replace(u,"\0"));if(e.endsWith("/*")){const r=l(e.substring(0,e.length-2));return new RegExp("^(("+s+")|("+r+"))$","i")}return new RegExp("^"+s+"$","i")}(e)}function p(e){return{actions:(e.actions||[]).map(m),notActions:(e.notActions||[]).map(m)}}function P(e,s){const o=[];let i=Promise.resolve(!1);const c=n.ArmId.parse(e,!0);if(0!==c.kind){const e=c.subscription;e&&(i=(0,t.isCoAdminOnSub)(e))}return i.then((t=>{if(t)return Promise.resolve(a);return(0,r.callWithContinuation)([(0,r.getPermissionsApi)(e)],(e=>{(e||[]).forEach((e=>{const s={actions:e.actions||[],notActions:e.notActions||[]};o.push(s)}))}),(e=>{throw e.reason}),s+".ServicesPermissions.getPermissions").then((()=>o)).catch((e=>{switch(e&&e.jqXHR&&e.jqXHR.status){case 403:case 401:return[{actions:[],notActions:[]}]}throw e}))}))}s.hasPermissionsImpl=function(e,s,r,t){const n=c.start({source:t,action:"CheckPermissions",name:MsPortalFx.sanitizeMessage(s)});let i=!1;return e.get(o.PermissionsChecker).hasPermission(s,r,null,t).then((e=>(i=!0,e))).finally((()=>{c.endTrace(n,i,r)}))},s.getPermissions=function(e,s){const r=c.start({source:s,action:"GetPermissions",name:e});let t=!1;return P(e,s).then((e=>(t=!0,e)),(()=>a)).finally((()=>{c.endTrace(r,t)}))},s.getPermissionsFromArm=P,s.hasPermission=function(e,s,r,t,i){if("string"!=typeof e)return Promise.resolve().then((()=>{throw new Error(`EntityId is not a string. ${ko.toJSON(e)}`)}));if(e.startsWith("/")||(e="/"+e),(0,o.isRDFEAction)(s)){const r=new MsPortalFx.Errors.Error("Cannot evaluate RDFE actions, get permissions directly from hubs");return r.data={id:e,reqActions:s},Promise.reject(r)}const c=n.ArmId.parse(e,!0);if(0===c.kind){const r=new MsPortalFx.Errors.Error(`Invalid subscription, resource or resource group id '${n.ArmId.sanitizeId(c)}'`);return r.data={id:e,reqActions:s},Promise.reject(r)}const a={resourceType:c.resourceType};let u;return u=r&&r.length?Promise.resolve([{actions:r||[],notActions:[]}]):t(e,i),u.then((e=>function(e,s,r,t){if(!s||!t||0===t.length)return!1;const n=t.map(p);return s.every((e=>(e.length>1&&e.startsWith(".")&&"/"===e.charAt(1)&&(e="{resourceType}"+e.substring(1)),e=e.format(r),n.some((s=>function(e,s){const r=s.actions.some((s=>s.test(e))),t=s.notActions.some((s=>s.test(e)));return r&&!t}(e,s))))))}(0,s,a,e)),(()=>!0))}}));